name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup TTS Resources
        shell: pwsh
        run: |
          Write-Host "Setting up TTS resources for build..." -ForegroundColor Cyan

          # Create directories
          $resourcesDir = "tts_resources"
          New-Item -ItemType Directory -Force -Path "$resourcesDir\piper\bin" | Out-Null
          New-Item -ItemType Directory -Force -Path "$resourcesDir\piper\voices" | Out-Null
          New-Item -ItemType Directory -Force -Path "$resourcesDir\ffmpeg" | Out-Null

          # Download Piper TTS
          Write-Host "Downloading Piper TTS..." -ForegroundColor Yellow
          $piperUrl = "https://github.com/rhasspy/piper/releases/download/2023.11.14-2/piper_windows_amd64.zip"
          $piperZip = "$resourcesDir\piper.zip"
          Invoke-WebRequest -Uri $piperUrl -OutFile $piperZip -UseBasicParsing
          Expand-Archive -Path $piperZip -DestinationPath "$resourcesDir\piper\bin" -Force
          Remove-Item $piperZip
          Write-Host "Piper TTS downloaded" -ForegroundColor Green

          # Download FFmpeg
          Write-Host "Downloading FFmpeg..." -ForegroundColor Yellow
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          $ffmpegZip = "$resourcesDir\ffmpeg.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip -UseBasicParsing
          Expand-Archive -Path $ffmpegZip -DestinationPath $resourcesDir -Force

          $ffmpegExtracted = Get-ChildItem -Path $resourcesDir -Filter "ffmpeg-master-latest-win64-gpl" -Directory | Select-Object -First 1
          if ($ffmpegExtracted) {
              Copy-Item "$($ffmpegExtracted.FullName)\bin\ffmpeg.exe" "$resourcesDir\ffmpeg\ffmpeg.exe" -Force
              Remove-Item $ffmpegExtracted.FullName -Recurse -Force
          }
          Remove-Item $ffmpegZip -ErrorAction SilentlyContinue
          Write-Host "FFmpeg downloaded" -ForegroundColor Green

          # Download Russian Piper voices
          Write-Host "Downloading Russian voices..." -ForegroundColor Yellow
          $russianVoices = @(
              @{name="denis"; quality="medium"},
              @{name="dmitri"; quality="medium"},
              @{name="irina"; quality="medium"},
              @{name="ruslan"; quality="medium"}
          )

          foreach ($voice in $russianVoices) {
              $name = $voice.name
              $quality = $voice.quality
              $voiceDir = "$resourcesDir\piper\voices\ru_RU\$name\$quality"
              New-Item -ItemType Directory -Force -Path $voiceDir | Out-Null

              $baseUrl = "https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/ru/ru_RU/$name/$quality"
              $fileName = "ru_RU-$name-$quality"

              Write-Host "  Downloading $name..." -ForegroundColor Gray
              Invoke-WebRequest -Uri "$baseUrl/$fileName.onnx" -OutFile "$voiceDir\$fileName.onnx" -UseBasicParsing
              Invoke-WebRequest -Uri "$baseUrl/$fileName.onnx.json" -OutFile "$voiceDir\$fileName.onnx.json" -UseBasicParsing
          }
          Write-Host "Russian voices downloaded" -ForegroundColor Green

          # Download English Piper voices
          Write-Host "Downloading English voices..." -ForegroundColor Yellow
          $englishVoices = @(
              @{name="amy"; quality="low"},
              @{name="lessac"; quality="medium"},
              @{name="ryan"; quality="medium"}
          )

          foreach ($voice in $englishVoices) {
              $name = $voice.name
              $quality = $voice.quality
              $voiceDir = "$resourcesDir\piper\voices\en_US\$name\$quality"
              New-Item -ItemType Directory -Force -Path $voiceDir | Out-Null

              $baseUrl = "https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_US/$name/$quality"
              $fileName = "en_US-$name-$quality"

              Write-Host "  Downloading $name..." -ForegroundColor Gray
              Invoke-WebRequest -Uri "$baseUrl/$fileName.onnx" -OutFile "$voiceDir\$fileName.onnx" -UseBasicParsing
              Invoke-WebRequest -Uri "$baseUrl/$fileName.onnx.json" -OutFile "$voiceDir\$fileName.onnx.json" -UseBasicParsing
          }
          Write-Host "English voices downloaded" -ForegroundColor Green

          Write-Host "TTS resources setup complete!" -ForegroundColor Cyan

      - name: Build application
        run: npm run build

      - name: Package for Windows
        run: npm run electron:build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List release directory
        run: dir release
        shell: cmd

      - name: Upload unsigned artifacts
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-unsigned
          path: release/*
          retention-days: 5

  sign-windows:
    needs: build-windows
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download unsigned artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build-unsigned
          path: release

      - name: List artifacts
        run: dir release
        shell: cmd

      - name: Sign with SignPath
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: 'de2fc7c1-46ef-46b1-98e8-dd431d2b785d'
          project-slug: 'Book_to_MP3'
          signing-policy-slug: 'release-signing'
          github-artifact-id: '${{ needs.build-windows.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: 'release-signed'

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-signed
          path: release-signed/*
          retention-days: 5

  release:
    needs: sign-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download signed artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build-signed
          path: release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.exe
            release/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
